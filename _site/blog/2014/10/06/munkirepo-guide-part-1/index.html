<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Setup a Munki repo on Ubuntu 14.04 - Part 1 &#8211; Just another tech blog</title>
<meta name="description" content="Gets the repo configured and shared via nginx. Plus, samba gets configured for remote administration.">
<meta name="keywords" content="">



<!-- Twitter Cards -->
<meta name="twitter:title" content="Setup a Munki repo on Ubuntu 14.04 - Part 1">
<meta name="twitter:description" content="Gets the repo configured and shared via nginx. Plus, samba gets configured for remote administration.">
<meta name="twitter:site" content="@clburlison">
<meta name="twitter:creator" content="@clburlison">

<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://clburlison.com/images/">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Setup a Munki repo on Ubuntu 14.04 - Part 1">
<meta property="og:description" content="Gets the repo configured and shared via nginx. Plus, samba gets configured for remote administration.">
<meta property="og:url" content="https://clburlison.com/blog/2014/10/06/munkirepo-guide-part-1/">
<meta property="og:site_name" content="Just another tech blog">





<link rel="canonical" href="https://clburlison.com/blog/2014/10/06/munkirepo-guide-part-1/">
<link href="https://clburlison.com/feed.xml" type="application/atom+xml" rel="alternate" title="Just another tech blog Feed">


<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="https://clburlison.com/assets/css/main.css">

<meta http-equiv="cleartype" content="on">

<!-- HTML5 Shiv and Media Query Support -->
<!--[if lt IE 9]>
	<script src="https://clburlison.com/assets/js/vendor/html5shiv.min.js"></script>
	<script src="https://clburlison.com/assets/js/vendor/respond.min.js"></script>
<![endif]-->

<!-- Modernizr -->
<script src="https://clburlison.com/assets/js/vendor/modernizr-2.7.1.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="https://clburlison.com/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="https://clburlison.com/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="https://clburlison.com/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://clburlison.com/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://clburlison.com/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://clburlison.com/images/apple-touch-icon-144x144-precomposed.png">

</head>

<body class="post">

<!--[if lt IE 9]><div class="browser-upgrade alert alert-info">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</div><![endif]-->

<div class="navigation-wrapper">
	<div class="site-name">
		<a href="https://clburlison.com">Just another tech blog</a>
	</div><!-- /.site-name -->
	<div class="top-navigation">
		<nav role="navigation" id="site-nav" class="nav">
		    <ul>
		        
					    
					        
					    
					    <li><a href="https://clburlison.com/about/" >About</a></li>
					  
					    
					        
					    
					    <li><a href="https://clburlison.com/resources/" >Resources</a></li>
					  
					    
					        
					    
					    <li><a href="https://clburlison.com/blog/archives/" >Archives</a></li>
					  
		    </ul>
		</nav>
	</div><!-- /.top-navigation -->
</div><!-- /.navigation-wrapper -->



<div id="main" role="main">
  <div class="article-author-side">
    



	<img src="https://clburlison.com/images/me.jpg" class="bio-photo" alt="Clayton Burlison bio photo"></a>

<h3>Clayton Burlison</h3>
<p>A Mac sysadmin, documenting useful code, ideas, & guides.</p>
<a href="mailto:clburlison@gmail.com" class="author-social" target="_blank"><i class="fa fa-envelope-square"></i> Email</a>
<a href="http://twitter.com/clburlison" class="author-social" target="_blank"><i class="fa fa-twitter-square"></i> Twitter</a>
<a href="http://facebook.com/clburlison" class="author-social" target="_blank"><i class="fa fa-facebook-square"></i> Facebook</a>

<a href="http://linkedin.com/in/clburlison" class="author-social" target="_blank"><i class="fa fa-linkedin-square"></i> LinkedIn</a>


<a href="http://github.com/clburlison" class="author-social" target="_blank"><i class="fa fa-github"></i> Github</a>






  </div>
  <article>
    <div class="headline-wrap">
      
        <h1><a href="https://clburlison.com/blog/2014/10/06/munkirepo-guide-part-1/" rel="bookmark" title="Setup a Munki repo on Ubuntu 14.04 - Part 1">Setup a Munki repo on Ubuntu 14.04 - Part 1</a></h1>
      
    Categories: 

<span class="categories">
  
    <a class='category' href='/blog/categories/munki/'>munki</a>, <a class='category' href='/blog/categories/ubuntu/'>ubuntu</a>
  
</span>

	 
    </div><!--/ .headline-wrap -->
    <div class="article-wrap">
      <section id="table-of-contents" class="toc">
  <header>
    <h3>Overview</h3>
  </header>
<div id="drawer">
<ul id="markdown-toc">
  <li><a href="#intro">Intro</a></li>
  <li><a href="#the-install">The Install</a>    <ul>
      <li><a href="#installing-required-software">Installing Required Software</a>        <ul>
          <li><a href="#setup-the-directories">Setup the directories:</a></li>
          <li><a href="#creating-the-service-accounts--set-directory-permissions">Creating the service accounts &amp; set directory permissions:</a></li>
        </ul>
      </li>
      <li><a href="#setting-up-nginx">Setting up Nginx</a>        <ul>
          <li><a href="#securing-your-munkirepo">Securing your munki_repo</a></li>
        </ul>
      </li>
      <li><a href="#setting-up-samba">Setting up Samba</a></li>
    </ul>
  </li>
  <li><a href="#conclusion">Conclusion</a></li>
</ul>

  </div>
</section>
<!-- /#table-of-contents -->

<h1 id="intro">Intro</h1>

<p>As you might have guessed from my previous <a href="/blog/2014/10/02/reposado-guide/">post</a>, I am trying to standardize at work. Part of this was to move many core OS X services away from OS X Server and towards Ubuntu. This will allow us to use our existing virtualization infrastructure. After reposado the next big service was our munki repo. </p>

<p><img class="center" src="/images/posts/2014-10-06/munki.jpg" width="400" height="400" /></p>

<p><a href="http://github.com/munki/munki">Munki</a> is a very powerful open source tool for patch management and software updates for OS X clients. The client component is pretty easy to install but the server component can be a bit more tricky for newer administrators. The goal of this guide is to walk through setting up the server web share with http basic authentication (read simply security), and lastly setup samba so we can remote into our web server to manage files. </p>

<p>In the past, our munki_repo has been shared using apache but due to some research and a few internal tests I will be using nginx as the backend in this guide. </p>

<p>Since our Munki setup has many add-on projects including: <a href="https://github.com/wollardj/Mandrill">mandrill</a>,  <a href="https://github.com/munkireport/munkireport-php/">munkireport-php</a>, and our in-house rsync replication I will be splitting this series into multiple parts. </p>

<p><img src="/images/posts/2014-10-06/managed_software_center.png" width="600" height="600" /></p>

<h1 id="the-install">The Install</h1>

<p>As a matter of good practice, we are going to make sure our Ubuntu server is fully patched before we start. Then we will install <em>git, curl, build-essential, nginx, and apache2-utils, samba</em>. </p>

<h2 id="installing-required-software">Installing Required Software</h2>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">sudo apt-get update
sudo apt-get upgrade
sudo apt-get -y install git curl build-essential nginx apache2-utils samba</code></pre></div>

<h3 id="setup-the-directories">Setup the directories:</h3>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">sudo mkdir /usr/local/munki_repo
sudo mkdir -p /etc/nginx/sites-enabled/
ln -s /usr/local/munki_repo/ ~/
<span class="nb">cd</span> /usr/local/munki_repo
sudo mkdir catalogs client_resources icons manifests pkgs pkgsinfo</code></pre></div>

<h3 id="creating-the-service-accounts--set-directory-permissions">Creating the service accounts &amp; set directory permissions:</h3>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">sudo addgroup --system munki
sudo adduser --system munki --ingroup munki
sudo usermod -a -G munki <span class="nv">$USER</span> <span class="c"># Adds the current console user to munki group</span>
sudo usermod -a -G munki www-data <span class="c"># Adds web user to munki group</span>
sudo chown -R <span class="nv">$USER</span>:munki /usr/local/munki_repo
sudo chmod -R <span class="m">2774</span> /usr/local/munki_repo</code></pre></div>

<h2 id="setting-up-nginx">Setting up Nginx</h2>
<p><em>Note:</em> if you read this guide before October 19th issue the following command before preceding to the setup below.<br />
<code>sudo rm /etc/nginx/sites-enabled/munki_repo.conf</code></p>

<p>Nginx is fast, light-weight, and uses a fraction of the resources that Apache uses. But don’t take my word for it there are lots of <a href="http://arstechnica.com/business/2011/11/a-faster-web-server-ripping-out-apache-for-nginx/">other reason</a> why <a href="http://wiki.nginx.org/WhyUseIt">you might want to use Nginx</a>.</p>

<p>Nginx’s installation on Ubuntu is very similar to Apache’s. All of its config files are stored in <em>/etc/nginx</em>.</p>

<p>Lets backup the original default file create and create our own.    </p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">sudo mv /etc/nginx/sites-available/default /etc/nginx/sites-available/default.bkup
sudo nano /etc/nginx/sites-available/default</code></pre></div>

<p>Make sure and change the server_name to match your server’s FQDN or IP.</p>

<div class="highlight"><pre><code class="language-html" data-lang="html">server {
  listen 80 default_server;
  listen [::]:80 default_server ipv6only=on;

  root /usr/share/nginx/html;
  index index.php index.html index.htm;

  server_name munki;

  location /munki_repo/ {
    alias /usr/local/munki_repo/;
    autoindex off;
    auth_basic &quot;Restricted&quot;;
    auth_basic_user_file /etc/nginx/.htpasswd;
  }
}</code></pre></div>

<p>And finally start the nginx service.<br />
<code>sudo /etc/init.d/nginx start</code></p>

<h3 id="securing-your-munkirepo">Securing your munki_repo</h3>
<p>For my purpose, I will be securing my munki_repo with simple http basic authentication. Depending on the needs of your organization this might be enough but you might need to look into ssl and other advanced options. If you are interesting in these options check out the <a href="https://github.com/munki/munki/wiki">munki wiki</a>.</p>

<p><strong>Create an http user and password</strong>
<code>sudo htpasswd -c /etc/nginx/.htpasswd munkihttpuser</code></p>

<p>The tool will prompt you to enter a password (make it strong).</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">New password: ******
Re-type new password: ******
Adding password <span class="k">for</span> user munkihttpuser</code></pre></div>

<p>The structure of the htpasswd is <code>login:password_hash</code>.</p>

<p>We must reload the nginx service to update the reflected change.<br />
<code>sudo /etc/init.d/nginx reload</code></p>

<p>Now when you try to access your website, <a href="">http://yourmunkiserver/munki_repo/</a>, you will notice a browser prompt that asks you to enter the login and password. Enter the details that you used while creating the .htpasswd file. The prompt does not allow you to access the website till you enter the right credentials. The munki client supports this security feature with the AdditionalHttpHeaders key <a href="https://github.com/munki/munki/wiki/Using-Basic-Authentication#configuring-the-clients-to-use-a-password">more info</a>.</p>

<p><em>Note:</em> If you do not want to secure your munki repo you can remove this setting in the above ngix config file by removing the two lines that start with <em>auth_basic</em>.</p>

<h2 id="setting-up-samba">Setting up Samba</h2>
<p>Now we just need a way to mount our munki_repo on a mac so we can do administrative things. Samba uses a separate set of passwords than the standard Linux system accounts (stored in /etc/samba/smbpasswd), so you’ll need to create a Samba password for yourself.  </p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">sudo smbpasswd -a munki
<span class="c">#output on the following lines</span>
New SMB password: *****
Retype new SMB password: ****
Added user munki.</code></pre></div>

<p>Now we need to share the munki_repo. Once “smb.conf” has loaded, add this to the very end of the file:<br />
<code>sudo nano /etc/samba/smb.conf</code></p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">[</span>munki_repo<span class="o">]</span>
<span class="nv">path</span> <span class="o">=</span> /usr/local/munki_repo 
<span class="nv">available</span> <span class="o">=</span> yes
valid <span class="nv">users</span> <span class="o">=</span> munki      
<span class="nb">read </span><span class="nv">only</span> <span class="o">=</span> no
<span class="nv">browseable</span> <span class="o">=</span> yes
<span class="nv">public</span> <span class="o">=</span> no 
<span class="nv">writable</span> <span class="o">=</span> yes</code></pre></div>

<p>Test for errors with the config file with: <code>testparm</code></p>

<p>Now we must restart samba.<br />
<code>sudo restart smbd</code></p>

<p>From your mac you will be able to access the munki_repo with the following <a href="">smb://munki.example.com/munki_repo</a>.</p>

<h1 id="conclusion">Conclusion</h1>
<p>We now have a working munki_repo fully configured and ready for use to start importing packages into the repo. If you are really new to Munki, this takes care of the “Demonstration Setup” section from the <a href="https://github.com/munki/munki/wiki">munki wiki</a>. To start populating Munki with manifests, packages, and more I would recommend using <a href="https://github.com/hjuutilainen/munkiadmin">MunkiAdmin</a>.</p>

<hr />

<p>Articles:<br />
<a href="https://www.digitalocean.com/community/tutorials/how-to-configure-the-nginx-web-server-on-a-virtual-private-server">How to configure Nginx</a>,<br />
<a href="http://wiki.nginx.org/Configuration">Configuration - Official nginx documentation</a>,<br />
<a href="https://help.ubuntu.com/community/How%20to%20Create%20a%20Network%20Share%20Via%20Samba%20Via%20CLI%20(Command-line%20interface/Linux%20Terminal)%20-%20Uncomplicated,%20Simple%20and%20Brief%20Way!">Samba Setup</a>,<br />
<a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-http-authentication-with-nginx-on-ubuntu-12-10">Basic Http Auth with Nginx</a>,  </p>

<p>Update:<br />
Oct. 16, 2014 - Removed note about the htpasswd that was incorrect.<br />
Oct. 17, 2014 - Move samba error test command before you restart the samba service. Add reference URL to your munkiserver for authentication testing purposes.<br />
Oct. 19, 2014 - Nginx settings are now done in the <code>default</code> file. This change was made to support Munkireport.</p>

      <footer role="contentinfo">
        <div class="article-author-bottom">
          



	<img src="https://clburlison.com/images/me.jpg" class="bio-photo" alt="Clayton Burlison bio photo"></a>

<h3>Clayton Burlison</h3>
<p>A Mac sysadmin, documenting useful code, ideas, & guides.</p>
<a href="mailto:clburlison@gmail.com" class="author-social" target="_blank"><i class="fa fa-envelope-square"></i> Email</a>
<a href="http://twitter.com/clburlison" class="author-social" target="_blank"><i class="fa fa-twitter-square"></i> Twitter</a>
<a href="http://facebook.com/clburlison" class="author-social" target="_blank"><i class="fa fa-facebook-square"></i> Facebook</a>

<a href="http://linkedin.com/in/clburlison" class="author-social" target="_blank"><i class="fa fa-linkedin-square"></i> LinkedIn</a>


<a href="http://github.com/clburlison" class="author-social" target="_blank"><i class="fa fa-github"></i> Github</a>






        </div>
        <p><b>Published: </b><time datetime="2014-10-06T22:55:49-05:00">October 06, 2014</time><br>
		<b>Modified:</b> <time datetime="2014-10-17">October 17, 2014</time></p>
      </footer>
    </div><!-- /.article-wrap -->
    <center><nav class="pagination" role="navigation">
      
        <a href="https://clburlison.com/blog/2014/10/02/reposado-guide/" class="btn" title="Setup Reposado + Margarita on Ubuntu 14.04">Previous article</a>
      
      
        <a href="https://clburlison.com/blog/2014/10/19/munkirepo-guide-part-2/" class="btn" title="Setup Mandrill on Ubuntu 14.04 - Part 2">Next article</a>
      
    </nav><!-- /.pagination --></center>
    <hr />
  
    <section id="disqus_thread"></section><!-- /#disqus_thread -->
  
  </article>
</div><!-- /#main -->

<div class="footer-wrap">

  <footer>
    <div class="google-ads">
  <!-- 320 x 50 ad -->
  <script async src="http://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <ins class="adsbygoogle"
       style="display:inline-block;width:320px;height:50px"
       data-ad-client=""
       data-ad-slot=""></ins>
  <script>
  (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div><!-- /.google-ads -->

<span>&copy; 2014 Clayton Burlison. Powered by <a href="http://jekyllrb.com">Jekyll</a> using the <a href="http://mademistakes.com/minimal-mistakes/">Minimal Mistakes</a> theme.</span>
  </footer>
</div><!-- /.footer-wrap -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="https://clburlison.com/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="https://clburlison.com/assets/js/scripts.min.js"></script>


  
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'clburlison'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

	        

</body>
</html>